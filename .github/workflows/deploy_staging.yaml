name: ğŸš€ Build and Deploy Gatsby App - Staging

on:
  push:
    branches:
      - staging

  repository_dispatch:
    types:
      - strapi-staging

concurrency:
  group: environment-staging
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:

    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v3
      with:
        ref: staging

    - name: ğŸ“Œ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: âš™ï¸ Install Dependencies
      run: npm install

    - name: ğŸ“ Create Environment Variables
      run: |
        echo "GATSBY_BACKEND_API_TOKEN=${{ secrets.BACKEND_API_TOKEN }}" >> .env.production
        echo "GATSBY_BACKEND_URL=${{ secrets.BACKEND_URL }}" >> .env.production

    - name: ğŸ—ï¸ Build Gatsby App for Production
      run: npm run build  

    - name: ğŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: ${{ secrets.FTP_PORT }}
        protocol: ftps
        local-dir: "public/"
        server-dir: "staging/" 